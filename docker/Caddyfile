# Production: replace the domain below with your actual domain or DDNS hostname.
# Caddy will automatically obtain a Let's Encrypt certificate via HTTP-01 challenge.
# Port 80 and 443 must be open and forwarded to this host on your router.
#
# For local development (no TLS), replace the domain with ":80".
#
# Auth modes (set AUTH_MODE in .env):
#   oauth  — client_credentials flow via auth service; Claude/ChatGPT OAuth inputs
#   none   — no auth (default; development / trusted network use)

your-domain.ddns.net {
    # OAuth discovery + token endpoints — always forwarded to auth service (no auth required)
    handle /.well-known/* {
        reverse_proxy auth:9000
    }

    handle /oauth/* {
        reverse_proxy auth:9000
    }

    # MCP endpoint — guarded when AUTH_MODE=oauth
    @oauth_mode {
        path /mcp*
        expression `{env.AUTH_MODE} == "oauth"`
    }
    handle @oauth_mode {
        forward_auth auth:9000 {
            uri /oauth/verify
            header_up Authorization {http.request.header.Authorization}
        }
        reverse_proxy mcp:8000
    }

    # AUTH_MODE=none or unset — no auth
    handle /mcp* {
        reverse_proxy mcp:8000
    }

    header {
        -X-Accel-Buffering
    }
}
